{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/DevProjects/prospra/app/api/onboarding/route.ts"],"sourcesContent":["// @ts-nocheck\r\n\r\nimport { NextResponse, NextRequest } from \"next/server\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Use the incoming request's cookies directly (same as proxy.ts)\r\n    const supabase = createServerClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n      {\r\n        cookies: {\r\n          get(name: string) {\r\n            // Read auth cookies from this request\r\n            return request.cookies.get(name)?.value;\r\n          },\r\n          // We don't need to mutate cookies in this route,\r\n          // so these are safe no-ops.\r\n          set() {},\r\n          remove() {},\r\n        },\r\n      }\r\n    );\r\n\r\n    const data = await request.json();\r\n\r\n    // ---- Build update object ----\r\n    const updateData: any = {};\r\n    const fields = [\r\n      \"name\",\r\n      \"industry\",\r\n      \"stage\",\r\n      \"website\",\r\n      \"audience\",\r\n      \"offer\",\r\n      \"goal90\",\r\n      \"challenge\",\r\n    ];\r\n\r\n    fields.forEach((key) => {\r\n      if (data[key] !== undefined && data[key] !== null) {\r\n        updateData[key] = data[key];\r\n      }\r\n    });\r\n\r\n    updateData.onboarding_complete = true;\r\n\r\n    // ---- Get User from Supabase (using request cookies) ----\r\n    const {\r\n      data: { user },\r\n      error: userError,\r\n    } = await supabase.auth.getUser();\r\n\r\n    console.log(\"üîç Onboarding API - User check:\", {\r\n      hasUser: !!user,\r\n      userId: user?.id,\r\n      userError: userError?.message,\r\n      cookiesPresent: request.cookies.getAll().map(c => c.name),\r\n    });\r\n\r\n    if (userError || !user) {\r\n      console.error(\"‚ùå User error in onboarding route:\", userError);\r\n      return NextResponse.json({ error: \"Not logged in\" }, { status: 401 });\r\n    }\r\n\r\n    // ---- Update profile ----\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update(updateData)\r\n      .eq(\"id\", user.id);\r\n\r\n    if (updateError) {\r\n      console.error(\"Profile update error:\", updateError);\r\n      return NextResponse.json(\r\n        { error: updateError.message },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // ---- Get access token for Edge Function ----\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n\r\n    const access_token = session?.access_token;\r\n\r\n    // ---- Trigger Website Analyzer (optional) ----\r\n    if (access_token && updateData.website) {\r\n      try {\r\n        await fetch(\r\n          `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/website-analyzer`,\r\n          {\r\n            method: \"POST\",\r\n            headers: {\r\n              \"Content-Type\": \"application/json\",\r\n              Authorization: `Bearer ${access_token}`,\r\n            },\r\n            body: JSON.stringify({\r\n              website: updateData.website,\r\n              user_id: user.id,\r\n            }),\r\n          }\r\n        );\r\n      } catch (err) {\r\n        console.error(\"Website analyzer error:\", err);\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ success: true }, { status: 200 });\r\n  } catch (err: any) {\r\n    console.error(\"Onboarding API Error:\", err);\r\n    return NextResponse.json(\r\n      { error: err.message || \"Unexpected server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,cAAc;;;;;AAEd;AACA;AAAA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,iEAAiE;QACjE,MAAM,WAAW,IAAA,iMAAkB,sUAGjC;YACE,SAAS;gBACP,KAAI,IAAY;oBACd,sCAAsC;oBACtC,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,OAAO;gBACpC;gBACA,iDAAiD;gBACjD,4BAA4B;gBAC5B,QAAO;gBACP,WAAU;YACZ;QACF;QAGF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAE/B,gCAAgC;QAChC,MAAM,aAAkB,CAAC;QACzB,MAAM,SAAS;YACb;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,OAAO,OAAO,CAAC,CAAC;YACd,IAAI,IAAI,CAAC,IAAI,KAAK,aAAa,IAAI,CAAC,IAAI,KAAK,MAAM;gBACjD,UAAU,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI;YAC7B;QACF;QAEA,WAAW,mBAAmB,GAAG;QAEjC,2DAA2D;QAC3D,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACd,OAAO,SAAS,EACjB,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,QAAQ,GAAG,CAAC,mCAAmC;YAC7C,SAAS,CAAC,CAAC;YACX,QAAQ,MAAM;YACd,WAAW,WAAW;YACtB,gBAAgB,QAAQ,OAAO,CAAC,MAAM,GAAG,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI;QAC1D;QAEA,IAAI,aAAa,CAAC,MAAM;YACtB,QAAQ,KAAK,CAAC,qCAAqC;YACnD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,2BAA2B;QAC3B,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,YACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,KAAK,EAAE;QAEnB,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,YAAY,OAAO;YAAC,GAC7B;gBAAE,QAAQ;YAAI;QAElB;QAEA,+CAA+C;QAC/C,MAAM,EACJ,MAAM,EAAE,OAAO,EAAE,EAClB,GAAG,MAAM,SAAS,IAAI,CAAC,UAAU;QAElC,MAAM,eAAe,SAAS;QAE9B,gDAAgD;QAChD,IAAI,gBAAgB,WAAW,OAAO,EAAE;YACtC,IAAI;gBACF,MAAM,MACJ,gFAAwC,8BAA8B,CAAC,EACvE;oBACE,QAAQ;oBACR,SAAS;wBACP,gBAAgB;wBAChB,eAAe,CAAC,OAAO,EAAE,cAAc;oBACzC;oBACA,MAAM,KAAK,SAAS,CAAC;wBACnB,SAAS,WAAW,OAAO;wBAC3B,SAAS,KAAK,EAAE;oBAClB;gBACF;YAEJ,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC,2BAA2B;YAC3C;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK,GAAG;YAAE,QAAQ;QAAI;IAC5D,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,IAAI,OAAO,IAAI;QAA0B,GAClD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}